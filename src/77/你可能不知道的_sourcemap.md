# åäººåè¨€

https://m.signalvnoise.com/ive-never-had-a-goal/

æˆ‘ä»æ¥æ²¡æœ‰ç›®æ ‡

æˆ‘ä»æ¥æ²¡æœ‰ç›®æ ‡, åªæ˜¯ä¸€ç›´åœ¨åš.

æˆ‘ä¸è®°å¾—è‡ªå·±æœ‰ä»€ä¹ˆç›®æ ‡ï¼Œé‚£ç§å¾ˆå…·ä½“çš„ç›®æ ‡ã€‚

æœ‰äº›äº‹æƒ…æˆ‘ä¸€ç›´æƒ³åšï¼Œä½†å¦‚æœä¸åšï¼Œæˆ‘ä¹Ÿèƒ½æ¥å—ã€‚æœ‰äº›äº‹æƒ…å€¼å¾—å»åšï¼Œä½†å¦‚æœæ²¡æœ‰åšåˆ°ï¼Œæˆ‘ä¹Ÿä¸è§‰å¾—å¾ˆé—æ†¾ã€‚

æˆ‘çš„ç›®æ ‡ä¸æ˜¯é‚£æ ·ã€‚

æˆ‘åšäº‹ï¼Œæˆ‘å°è¯•ï¼Œæˆ‘å»ºé€ ï¼Œæˆ‘æƒ³è¦å–å¾—è¿›æ­¥ï¼Œæˆ‘æƒ³è®©æˆ‘åšçš„ä¸œè¥¿ä½¿å¾—è‡ªå·±ã€ä½¿å¾—å…¬å¸ã€ä½¿å¾—å®¶åº­ã€ä½¿å¾—ç¤¾ä¼šå˜å¾—æ›´å¥½ã€‚ä½†æˆ‘ä»æœªè®¾å®šè¿‡ç›®æ ‡ã€‚è¿™ä¸æ˜¯æˆ‘åšäº‹çš„æ–¹å¼ã€‚

ç›®æ ‡æ˜¯å½“ä½ åˆ°è¾¾æ—¶å°±ä¼šæ¶ˆå¤±çš„ä¸œè¥¿ã€‚ä¸€æ—¦ä½ åˆ°è¾¾äº†ï¼Œå®ƒå°±æ¶ˆå¤±äº†ã€‚ä½ æ€»æ˜¯å¯ä»¥è®¾ç½®å¦ä¸€ä¸ªï¼Œæˆ‘åªæ˜¯ä¸æŒ‰è¿™æ ·çš„æ­¥éª¤è¡Œäº‹ã€‚

æˆ‘åªæ˜¯åšæˆ‘æ­£åœ¨åšçš„äº‹æƒ…ï¼Œç„¶åå°±åˆ°äº†ç°åœ¨çš„åœ°æ–¹ã€‚ä»Šå¤©æˆ‘ç»§ç»­ä»¥åŒæ ·çš„æ–¹å¼å¯¹å¾…å·¥ä½œå’Œç”Ÿæ´»ã€‚

### è€ƒè™‘é—®é¢˜çš„ä¸€èˆ¬æ­¥éª¤

1. ä¸Šä¸‹æ–‡(èƒŒæ™¯)
2. æ˜¯ä»€ä¹ˆ
3. æ€ä¹ˆç”¨(æ¯”å¦‚ æ€ä¹ˆå¯åŠ¨, ç”Ÿæˆç­‰)
4. åŸç†
5. å‘æ•£

## ä»‹ç»

ç•¥

### ğŸ‘½ ç®€å•è¯´

ç®€å•è¯´ï¼ŒSource map å°±æ˜¯ä¸€ä¸ªä¿¡æ¯æ–‡ä»¶ï¼Œé‡Œé¢å‚¨å­˜ç€ä½ç½®ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè½¬æ¢åçš„ä»£ç çš„æ¯ä¸€ä¸ªä½ç½®ï¼Œæ‰€å¯¹åº”çš„è½¬æ¢å‰çš„ä½ç½®ã€‚

æ‰€ä»¥, source map æ˜¯ä¸€ä¸ª map, æ—¢ä¸æ˜¯å‹ç¼©æ–‡ä»¶, ä¹Ÿä¸æ˜¯æºæ–‡ä»¶. ğŸ˜¹
(æˆ‘è¿™ä¹ˆè¯´, æ˜¯å› ä¸ºæˆ‘ç»å¸¸æœ‰æ­¤ç§å¹»è§‰ ğŸ‘¼)

### ğŸ‘€ çœ‹ä¸€ä¸‹

ä¸€èˆ¬æˆ‘ä»¬ç»å¸¸çœ‹åˆ°çš„ `sourcemap` å¦‚ä¸‹

```
//# sourceMappingURL=/path/to/filename.js.map
```

## â“ æ€ä¹ˆå¯ç”¨

1. ä»£ç 
   åªè¦åœ¨ **è½¬æ¢å** çš„ä»£ç å°¾éƒ¨ï¼ŒåŠ ä¸Šä¸€è¡Œå°±å¯ä»¥äº†ã€‚

```js
//# sourceMappingURL=/path/to/filename.js.map
```

æ—¢ç„¶æ˜¯ä¸€ä¸ªåœ°å€, æ‰€ä»¥ map æ–‡ä»¶ä¹Ÿå¯ä»¥æ”¾åœ¨è¿œç«¯, é‚£æˆ‘ä»¬å°è¯•ä¸€ä¸‹

2. æµè§ˆå™¨
   è°·æ­Œä¸­å¯ç”¨ `sourcemap`
   Enable JavaScript source maps

## ç¤ºä¾‹

æ˜¯å¦å¯ä»¥æ‰‹åŠ¨åŠ è½½ sourcemap æ–‡ä»¶?
[å‹ç¼©åçš„æ–‡ä»¶åœ°å€](https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js)
[sourcemap çš„ä¸€ä¸ªåœ°å€](https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.map)

## â“ å¦‚ä½•ç”Ÿæˆ

æ‘˜å½•åœ¨ é˜®å¤§ç¥ç¤ºä¾‹

```
java -jar compiler.jar \
ã€€ã€€ã€€ã€€--js script.js \
ã€€ã€€ã€€ã€€--create_source_map ./script-min.js.map \
ã€€ã€€ã€€ã€€--source_map_format=V3 \
ã€€ã€€ã€€ã€€--js_output_file script-min.js
```

è§£é‡Š

```
   - jsï¼š è½¬æ¢å‰çš„ä»£ç æ–‡ä»¶
   - create_source_mapï¼š ç”Ÿæˆçš„source mapæ–‡ä»¶
   - source_map_formatï¼šsource mapçš„ç‰ˆæœ¬ï¼Œç›®å‰ä¸€å¾‹é‡‡ç”¨V3ã€‚
   - js_output_fileï¼š è½¬æ¢åçš„ä»£ç æ–‡ä»¶ã€‚
```

## ğŸ”§ è‡ªå·±è¯•éªŒä¸€ä¸‹

> æ­¤åœ°å€åªæ˜¯æ¼”ç¤ºå‹ç¼©, å®é™…ä¸æ˜¯å¤ªå¥½ç”¨
> https://closure-compiler.appspot.com/home
> Google çš„ Closure ç¼–è¯‘å™¨
> https://developers.google.com/closure/compiler?hl=zh-cn

æ‰‹åŠ¨é¡¹ç›®æ¼”ç¤ºä¸€ä¸‹ [downloadlink](https://github.com/google/closure-compiler/wiki/Binary-Downloads)

```
java -jar closure-compiler-v20200719.jar --js origin.js --js_output_file origin.min.js --create_source_map origin.min.js.map --source_map_format=V3
```

#### å…¶ä»–

#### webpack ç›¸å…³

```json
devtool: 'source-map'
```

[webpack æ’ä»¶ terser](https://webpack.docschina.org/plugins/terser-webpack-plugin/)

å…¨å±€å®‰è£…çœ‹ä¸€ä¸‹

```
npm install -g terser

terser origin2.js -o foo.min.js -c -m --source-map "filename='foo.min.js.map',root='[http://foo.com/src',url='foo.min.js.map](http://foo.com/src',url='foo.min.js.map)'"

or simple
terser origin2.js -o foo.min.js -c -m --source-map "filename='foo.min.js.map'"

```

## soucemap ç»†èŠ‚

```json
{
  "version": 3,
  "file": "origin.min.js",
  "lineCount": 1,
  "mappings": "AAAAA,QAASA,KAAI,EAAE,CACdC,OAAA,CAAQC,GAAR,CAAY,gBAAZ,CADc;",
  "sources": ["origin.js"],
  "names": ["test", "console", "log"]
}
```

å¢åŠ  é˜®ä¸€å³° å¤§ç¥ç›¸å…³çš„è§£é‡Šå†…å®¹

```

   - versionï¼šSource mapçš„ç‰ˆæœ¬ï¼Œç›®å‰ä¸º3ã€‚

   - fileï¼šè½¬æ¢åçš„æ–‡ä»¶åã€‚

ã€€ã€€- sourceRootï¼šè½¬æ¢å‰çš„æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚å¦‚æœä¸è½¬æ¢å‰çš„æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ï¼Œè¯¥é¡¹ä¸ºç©ºã€‚

ã€€ã€€- sourcesï¼šè½¬æ¢å‰çš„æ–‡ä»¶ã€‚è¯¥é¡¹æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºå¯èƒ½å­˜åœ¨å¤šä¸ªæ–‡ä»¶åˆå¹¶ã€‚

ã€€ã€€- namesï¼šè½¬æ¢å‰çš„æ‰€æœ‰å˜é‡åå’Œå±æ€§åã€‚

ã€€ã€€- mappingsï¼šè®°å½•ä½ç½®ä¿¡æ¯çš„å­—ç¬¦ä¸²ï¼Œä¸‹æ–‡è¯¦ç»†ä»‹ç»ã€‚


```

> ç¬¬ä¸€å±‚æ˜¯**è¡Œå¯¹åº”**ï¼Œä»¥åˆ†å·ï¼ˆ;ï¼‰è¡¨ç¤ºï¼Œæ¯ä¸ªåˆ†å·å¯¹åº”è½¬æ¢åæºç çš„ä¸€è¡Œã€‚æ‰€ä»¥ï¼Œç¬¬ä¸€ä¸ªåˆ†å·å‰çš„å†…å®¹ï¼Œå°±å¯¹åº”æºç çš„ç¬¬ä¸€è¡Œï¼Œä»¥æ­¤ç±»æ¨ã€‚

ç¬¬äºŒå±‚æ˜¯**ä½ç½®å¯¹åº”**ï¼Œä»¥é€—å·ï¼ˆ,ï¼‰è¡¨ç¤ºï¼Œæ¯ä¸ªé€—å·å¯¹åº”è½¬æ¢åæºç çš„ä¸€ä¸ªä½ç½®ã€‚æ‰€ä»¥ï¼Œç¬¬ä¸€ä¸ªé€—å·å‰çš„å†…å®¹ï¼Œå°±å¯¹åº”è¯¥è¡Œæºç çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä»¥æ­¤ç±»æ¨ã€‚

ç¬¬ä¸‰å±‚æ˜¯**ä½ç½®è½¬æ¢**ï¼Œä»¥[VLQ ç¼–ç ](https://en.wikipedia.org/wiki/Variable-length_quantity)è¡¨ç¤ºï¼Œä»£è¡¨è¯¥ä½ç½®å¯¹åº”çš„è½¬æ¢å‰çš„æºç ä½ç½®ã€‚

> - ç¬¬ä¸€ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®åœ¨ï¼ˆè½¬æ¢åçš„ä»£ç çš„ï¼‰çš„ç¬¬å‡ åˆ—ã€‚

> - ç¬¬äºŒä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äº sources å±æ€§ä¸­çš„å“ªä¸€ä¸ªæ–‡ä»¶ã€‚

> - ç¬¬ä¸‰ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äºè½¬æ¢å‰ä»£ç çš„ç¬¬å‡ è¡Œã€‚

> - ç¬¬å››ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äºè½¬æ¢å‰ä»£ç çš„ç¬¬å‡ åˆ—ã€‚

> - ç¬¬äº”ä½ï¼Œè¡¨ç¤ºè¿™ä¸ªä½ç½®å±äº names å±æ€§ä¸­çš„å“ªä¸€ä¸ªå˜é‡ã€‚

## ç¨å¾®æ€»ç»“ä¸€ä¸‹

è¿™é‡Œå…¶å®å°±å·²ç» OK äº†, å¤§ä½“ç†è§£äº†ä»€ä¹ˆæ˜¯ `sourceMap`; ç„¶åå°±æ˜¯ å¥½å¥‡å¿ƒäº†.

### ğŸ¤” ç®—æ³•&æ€æƒ³

ä½†ä¸æ˜¯å¾ˆæ˜ç™½;

å…¶ä¸­æˆ‘ä»¬çœ‹åˆ° `mapping` ä¸­æ˜¯æˆ‘ä»¬ä¸è®¤è¯†çš„å†…å®¹; è¿™é‡Œä½¿ç”¨åˆ°äº†ä¸€ä¸ª `VLQ` ç¼–ç ;

**VLQ ç¼–ç ** æ˜¯ä»€ä¹ˆ? åè¾¹æˆ‘ä»¬ä¼šçœ‹ä¸€ä¸‹;

```
A variable-length quantity (VLQ) is a universal code that uses an arbitrary number of binary octets (eight-bit bytes) to represent an arbitrarily large integer. A VLQ is essentially a base-128 representation of an unsigned integer with the addition of the eighth bit to mark continuation of bytes.
```

äººè¯

**`VLQ`**Â (Variable-length quantity)æ˜¯ä¸€ç§é€šç”¨çš„ï¼Œä½¿ç”¨ä»»æ„ä½æ•°çš„äºŒè¿›åˆ¶æ¥è¡¨ç¤ºä¸€ä¸ªä»»æ„å¤§çš„æ•°å­—çš„ä¸€ç§ç¼–ç æ–¹å¼ã€‚

ç¼–ç å®ç°: å¯¹æ•°å­— 137 è¿›è¡Œ **VLQ**ç¼–ç ï¼Œä»¥ä¸‹ä¸ºåˆ†è§£æ­¥éª¤ï¼š

1. å°† 137 è½¬æˆäºŒè¿›åˆ¶å½¢å¼ â€”â€” 10001001
2. ä¸ƒä½ä¸€ç»„åšåˆ†ç»„ï¼Œä¸è¶³çš„è¡¥å‰å¯¼ 0 â€”â€” 0000001 0001001
3. æœ€åä¸€ç»„å¼€å¤´è¡¥ 0ï¼Œå…¶ä½™è¡¥ 1(1 è¡¨ç¤ºè¿ç»­ä½) â€”â€” 10000001 00001001.
4. æœ€ç»ˆ 137 çš„ VLQ ç¼–ç å½¢å¼ä¸º â€”â€” 10000001 00001001

VLQ è§£ç  :https://www.murzwin.com/base64vlq.html

### â‰ï¸ ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤„ç†?

1. ä½æ•°æ˜æ˜¾å˜é•¿äº†
2. æ„Ÿè§‰å ç”¨ç©ºé—´å˜å¤šäº†

åŸå› :

1. è§£å†³åºå·è¿‡å¤§é—®é¢˜
   1. å› ä¸ºä¸€è¡Œ, åæ ‡å¯èƒ½ä¼šéå¸¸å¤§,é‡‡ç”¨ç›¸å¯¹ä½ç½®
2. è§£å†³å ç”¨ç©ºé—´è¿‡å¤§é—®é¢˜
   1. å­—ç¬¦å ç”¨ vs æ•°å­—å ç”¨
      1. CAAQC =>> 1,0,0,8,1
      2. è¿ç»­å­—ç¬¦çš„é—®é¢˜

### å‚è€ƒåœ°å€

https://juejin.cn/post/6908642204185690119 æ–°æ–°äººç±»
https://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html æ•´ä½“ç²¾ç®€ä»‹ç»
https://www.51cto.com/article/665239.html è§£é‡Šäº† base64-vlq
https://www.liu.app/2020/04/08/Code/%E4%BD%BF%E7%94%A8Google%20Closure%20Compiler%E5%8E%8B%E7%BC%A9js%E5%B9%B6%E7%94%9F%E6%88%90Source%20map%E6%96%B9%E4%BE%BF%E8%B0%83%E8%AF%95/ é‡Šç–‘è§£æƒ‘
https://github.com/google/closure-compiler show me the code
